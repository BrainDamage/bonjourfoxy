<html>
<head>
<script type="text/javascript">
netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
var component_findservices;
var component_findinstances;
var component_resolver;

var servicetypes_state=Object();
var serviceinstances_state=Object();

var serviceinstance = "";

function resolveservice_callback(error, interfaceIndex, hostname, port, txtKey, txtValue)   {
    if (!error) {
        document.getElementById('serviceinfo').innerHTML = [
            "Hostname: " + hostname,
            "Port: " + port,
            "txtKey: " + txtKey,
            "txtValue: " + txtValue,
            ].join("\n");
    }
}

function resolveservice(sname, rtype, rdomain)  {
    netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
    component_resolver=Components.classes["@bonjourfoxy.net/bfdnssd;1"]
              .createInstance(Components.interfaces.BFIDNSSD);
    component_resolver.resolveCallback=resolveservice_callback;
    component_resolver.interfaceIndex=0;
    component_resolver.serviceName=sname;
    component_resolver.registrationType=rtype;
    component_resolver.registrationDomain=rdomain;
    component_resolver.resolve();
}

function findinstance_callback(error, add, ifIndex, sname, rtype, rdomain){
    if (!error) {
        si = sname;
        if (!servicetypes_state[si]) {
            servicetypes_state[si]=0;
            }
        selbox = document.getElementById("serviceinstances");
        if (add) {
            servicetypes_state[si]++;
            if (servicetypes_state[si]==1) {
                opt = document.createElement("option");
                opt.innerHTML = si;
                opt.onclick = function()    {
                    resolveservice(sname, rtype, rdomain);
                }
                selbox.appendChild(opt);
                }
            } else {
            servicetypes_state[si]--;
            if (servicetypes_state[si]==0) {
                for (child in selbox.childNodes) {
                    if (selbox.childNodes[child].innerHTML == si)    {
                        selbox.removeChild(selbox.childNodes[child]);
                        selbox.style.display = 'none';
                        selbox.style.display = '';
                    }
                }
            }
        }
    }
};

function find_serviceinstances(servicetype) {
    if (serviceinstance != servicetype) {
        netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
        serviceinstance = servicetype;
        selbox = document.getElementById("serviceinstances");
        while (selbox.childNodes.length>0)   {
            selbox.removeChild(selbox.childNodes[selbox.childNodes.length-1]);
        }
        component_findinstances=null;
        component_findinstances=Components.classes["@bonjourfoxy.net/bfdnssd;1"]
                  .createInstance(Components.interfaces.BFIDNSSD);
        component_findinstances.browseCallback=findinstance_callback;
        component_findinstances.interfaceIndex=0;
        component_findinstances.registrationType=servicetype;
        component_findinstances.registrationDomain="local";
        component_findinstances.browse();
    }
}

function findservice_callback (error, add, ifIndex, sname, rtype, rdomain){
    if (!error) {
        si = sname + "." + rtype.replace("local.","");
        if (!servicetypes_state[si]) {
            servicetypes_state[si]=0;
            }
        selbox = document.getElementById("servicetypes");
        if (add) {
            servicetypes_state[si]++;
            if (servicetypes_state[si]==1) {
                opt = document.createElement("option");
                opt.innerHTML = si;
                opt.onclick = function()  {
                    find_serviceinstances(this.innerHTML);
                }
                selbox.appendChild(opt);
                }
            } else {
            servicetypes_state[si]--;
            if (servicetypes_state[si]==0) {
                for (child in selbox.childNodes) {
                    if (selbox.childNodes[child].innerHTML == si)    {
                        selbox.removeChild(selbox.childNodes[child]);
                        selbox.style.display = 'none';
                        selbox.style.display = '';
                    }
                }
            }
        }
    }
};

function find_services()   {
    netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
    component_findservices=Components.classes["@bonjourfoxy.net/bfdnssd;1"]
              .createInstance(Components.interfaces.BFIDNSSD);
    component_findservices.browseCallback=findservice_callback;
    component_findservices.interfaceIndex=0;
    component_findservices.registrationType="_services._dns-sd._udp";
    component_findservices.registrationDomain="local";
    component_findservices.browse();
}

window.onload = find_services;
</script>
<style>
body { font-family: "Helvetica Neue", Helvetica, "MgOpen Moderna", sans-serif; background: #fdfdfd; }
h1 { color: #c00; }
h1, h2 { margin: 0; padding: 0; }
select { width: 100%; height: 20%; border: none; font-size: 1.1em; }
textarea { width: 100%; height: 20%; border: none; font-size: 1.1em; }
</style>
</head>
<body>
<h1>BFDNSSD Resolve Test</h1>
<h2>Pick a Service Type:</h2>
<select id="servicetypes" size="2">
</select>
<h2>Pick a Service Instance:</h2>
<select id="serviceinstances" size="2"></select>
<h2>Service Information:</h2>
<textarea id="serviceinfo"></textarea>
</body>
</html>